---
name: Delivery

on:
  push:
    branches:
    - main
  pull_request:

env:
  SERVICE_TAG: ktor-koin-template:latest

jobs:
  yaml-lint:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v6
    - name: Run yamllint
      uses: reviewdog/action-yamllint@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        reporter: github-pr-review
        fail_level: warning
        filter_mode: file
        level: warning

  github-actions-lint:
    runs-on: ubuntu-24.04
    permissions:
      contents: read
      pull-requests: write

    steps:
    - uses: actions/checkout@v6
    - name: Run actionlint
      uses: reviewdog/action-actionlint@v1
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        reporter: github-pr-review
        fail_level: warning
        level: warning

  lint:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6
    - name: Setup JDK
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: 21

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Run detekt
      run: ./gradlew detekt

  test:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6
    - name: Setup JDK
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: 21

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v5

    - name: Run tests and generate coverage report
      run: ./gradlew test integrationTest koverXmlReport koverHtmlReport

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v5
      with:
        files: build/reports/kover/report.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload test results to Codecov
      uses: codecov/test-results-action@v1
      with:
        files: build/test-results/**/*.xml
        fail_ci_if_error: false
        token: ${{ secrets.CODECOV_TOKEN }}

    - name: Upload coverage report artifact
      uses: actions/upload-artifact@v4
      with:
        name: kover-coverage-report
        path: build/reports/kover/
        retention-days: 30

  dependency-submission:
    runs-on: ubuntu-24.04
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v6
    - name: Setup JDK
      uses: actions/setup-java@v5
      with:
        distribution: 'zulu'
        java-version: 21

    - name: Generate and submit dependency graph
      uses: gradle/actions/dependency-submission@v5

  docker-build:
    runs-on: ubuntu-24.04
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v6
    - name: Set up QEMU
      uses: docker/setup-qemu-action@v3

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build
      uses: docker/build-push-action@v6
      with:
        context: .
        push: false
        tags: ${{ env.SERVICE_TAG }}
